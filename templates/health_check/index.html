{% extends "basis.html" %}

{% load i18n %}

{% block titel %}
{% block title %}{% trans 'Health checks'%}{% endblock title %}
{% endblock titel %}

{% block head %}
<meta name="robots" content="noindex">
<style type="text/css">
    .status_icon {
        display: inline-block;
        top: 2px;
        position: relative;
        margin-right: 4px;
    }
</style>
{% block extra_head %}{% endblock extra_head %}
{% endblock head %}

{% block content %}
  <div class="col-xs-12">
    <div class="ia">
      <h2>{% trans 'System status' %}</h2>

      <div class="content">
        <h3>{% trans 'System status' %}</h3>
        <table>
          <thead>
            <tr>
              <th colspan="2">{% trans 'Service' %}</th>
              <th>{% trans 'Status' %}</th>
              <th>{% trans 'Time Taken' %}</th>
            </tr>
          </thead>
          <tbody>
            {% for plugin in plugins %}
              <tr>
                <td style="width: 50px">
                  {% if plugin.status %}
                    <div class="icon status_icon icon-accept" aria-hidden="true"></div>
                  {% else %}
                    <div class="icon status_icon icon-cancel" aria-hidden="true"></div>
                  {% endif %}
                </td>
                <td>{{ plugin.identifier }}</td>
                <td>{{ plugin.pretty_status }}</td>
                <td>{{ plugin.time_taken|floatformat:4 }} {% trans 'seconds' %}</td>
              </tr>
            {% empty %}
                <td colspan="4">{% trans 'No status available.' %}</td>
            {% endfor %}
          </tbody>
        </table>

        <h3>{% trans 'Celery worker status' %}</h3>
        <table>
          <thead>
            <tr>
              <th colspan="2">{% trans 'Worker name' %}</th>
              <th>{% trans 'Active' %}</th>
              <th>{% trans 'Processed' %}</th>
              <th>{% trans 'Failed' %}</th>
              <th>{% trans 'Succeeded' %}</th>
              <th>{% trans 'Retried' %}</th>
              <th>{% trans 'Load average' %}</th>
              <th>{% trans 'Last heartbeat' %}</th>
            </tr>
          </thead>
          <tbody>
            {% for worker in celery_workers %}
              <tr>
                <td>
                  {% if worker.status %}
                    <div class="icon status_icon icon-accept" aria-hidden="true"></div>
                  {% else %}
                    <div class="icon status_icon icon-cancel" aria-hidden="true"></div>
                  {% endif %}
                </td>
                <td>
                    {% if worker.name %}
                        {{ worker.name }}
                    {% else %}
                        <div class="icon status_icon icon-error" aria-hidden="true">&nbsp;{% trans 'Unknown' %}</div>
                    {% endif %}
                </td>
                <td>{{ worker.active }}</td>
                <td>{{ worker.processed }}</td>
                <td>{{ worker.failed }}</td>
                <td>{{ worker.succeeded }}</td>
                <td>{{ worker.retried }}</td>
                <td>
                    {% if worker.loadavg %}
                        {{ worker.loadavg|join:', ' }}
                    {% else %}
                        <div class="icon status_icon icon-error" aria-hidden="true">&nbsp;{% trans 'Unknown' %}</div>
                    {% endif %}
                </td>
                <td>
                    {% if worker.last_heartbeat %}
                        <abbr title="{{ worker.last_heartbeat }}">{{ worker.last_heartbeat|timesince }}</abbr>
                    {% else %}
                        <div class="icon status_icon icon-error" aria-hidden="true">&nbsp;{% trans 'Unknown' %}</div>
                    {% endif %}
                </td>
              </tr>
            {% empty %}
                <td colspan="9">
                    <div class="icon status_icon icon-error" aria-hidden="true"></div>&nbsp;{% trans 'No worker status available.' %}
                </td>
            {% endfor %}
          </tbody>
        </table>

        <h3>{% trans 'RabbitMQ queue status' %}</h3>
        <table>
          <thead>
            <tr>
              <th>{% trans 'Name' %}</th>
              <th>{% trans 'State' %}</th>
              <th>{% trans '# Consumers' %}</th>
              <th>{% trans 'Queued messages' %}</th>
              <th><abbr title="{% trans 'Since last restart' %}">{% trans 'Total Incoming / Delivered' %}</abbr></th>
              <th>{% trans 'Last message received' %}</th>
            </tr>
          </thead>
          <tbody>
            {% for queue in rabbitmq_queues %}
              <tr>
                <td>
                    {% if queue.name %}
                        {% if queue.vhost %}{{ queue.vhost }}/{% endif %}{{ queue.name }}
                    {% else %}
                        <div class="icon status_icon icon-error" aria-hidden="true">&nbsp;{% trans 'Unknown' %}</div>
                    {% endif %}
                </td>
                <td>
                  {% if queue.state == "running" %}
                    <div class="icon status_icon icon-accept" aria-hidden="true"></div>
                  {% elif queue.state == "down" %}
                    <div class="icon status_icon icon-cancel" aria-hidden="true"></div>
                  {% else %}
                    <div class="icon status_icon icon-error" aria-hidden="true"></div>
                  {% endif %}
                  &nbsp;{% if queue.state %}{{ queue.state }}{% else %}{% trans 'Unknown' %}{% endif %}
                </td>
                <td>
                  {{ queue.consumers }}
                  {% if queue.consumers == 0 %}
                    &nbsp;<div class="icon status_icon icon-error" aria-hidden="true"></div>
                  {% endif %}
                </td>
                <td>
                    {{ queue.messages.current_queued|default:'0' }}
                </td>
                <td>
                    {% blocktrans with incoming=queue.messages.total_incoming|default:'0' delivered=queue.messages.total_delivered|default:'0' %}
                        {{ incoming }} incoming / {{ delivered }} delivered
                    {% endblocktrans %}
                </td>
                <td>
                    {% if queue.idle_since %}
                        <abbr title="{{ queue.idle_since }}">{{ queue.idle_since|timesince }}</abbr>
                    {% else %}
                        <div class="icon status_icon icon-error" aria-hidden="true">&nbsp;{% trans 'Unknown' %}</div>
                    {% endif %}
                </td>
              </tr>
            {% empty %}
                <td colspan="6">
                    <div class="icon status_icon icon-error" aria-hidden="true"></div>&nbsp;{% trans 'No queue status available.' %}
                </td>
            {% endfor %}
          </tbody>
        </table>

        {% if request.user and request.user.is_superuser and info_tables %}
        {% for title, data in info_tables %}
        <h3>{{ title }}</h3>
        <table>
          <tbody>
            {% for k, v in data.items %}
              <tr>
                <th>{{ k }}</th>
                <td>{{ v }}</td>
              </tr>
            {% empty %}
                <td colspan="2">{% trans 'No info available.' %}</td>
            {% endfor %}
          </tbody>
        </table>
        {% endfor %}
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}
